#!/usr/bin/env python3
"""
ark-core — ARKLinux Core Agent
Runs as non-root 'ark' user. Maintains state manifest, emits heartbeat.
All filesystem writes are restricted to /opt/ark/logs and /opt/ark/run.
"""
import json
import logging
import os
import signal
import sys
import time
from datetime import datetime, timezone
from pathlib import Path

# ── Configuration ─────────────────────────────────────────────────────────────
STATE_ROOT   = Path(os.environ.get("ARK_STATE_ROOT", "/opt/ark"))
LOG_PATH     = STATE_ROOT / "logs" / "core.log"
RUN_PATH     = STATE_ROOT / "run"
MANIFEST_DIR = STATE_ROOT / "aletheia" / "manifests"
HEARTBEAT_S  = 30   # seconds between heartbeat writes

# ── Logging setup ─────────────────────────────────────────────────────────────
LOG_PATH.parent.mkdir(parents=True, exist_ok=True)
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [ark-core] %(levelname)s %(message)s",
    handlers=[
        logging.FileHandler(LOG_PATH),
        logging.StreamHandler(sys.stdout),
    ],
)
log = logging.getLogger("ark-core")

# ── Graceful shutdown ─────────────────────────────────────────────────────────
_running = True

def _handle_signal(sig, _frame):
    global _running
    log.info("Received signal %s — shutting down", sig)
    _running = False

signal.signal(signal.SIGTERM, _handle_signal)
signal.signal(signal.SIGINT,  _handle_signal)

# ── Helpers ───────────────────────────────────────────────────────────────────
def write_atomic(path: Path, data: str) -> None:
    """Write to a temp file then rename (atomic on Linux)."""
    tmp = path.with_suffix(".tmp")
    tmp.write_text(data)
    tmp.rename(path)

def now_iso() -> str:
    return datetime.now(timezone.utc).isoformat(timespec="seconds")

def read_manifest() -> dict:
    manifest_file = MANIFEST_DIR / "state.json"
    if manifest_file.exists():
        try:
            return json.loads(manifest_file.read_text())
        except json.JSONDecodeError:
            log.warning("state.json corrupt — reinitialising")
    return {}

# ── Main ──────────────────────────────────────────────────────────────────────
def main() -> None:
    log.info("ARK Core Agent starting — state root: %s", STATE_ROOT)

    # Write PID file
    pid_file = RUN_PATH / "ark-core.pid"
    RUN_PATH.mkdir(parents=True, exist_ok=True)
    pid_file.write_text(str(os.getpid()))

    # Verify state root integrity
    for required in ["logs", "run", "aletheia/manifests"]:
        p = STATE_ROOT / required
        if not p.exists():
            log.error("Required path missing: %s — entering quarantine", p)
            sys.exit(1)

    manifest = read_manifest()
    log.info("Loaded manifest: version=%s build_id=%s",
             manifest.get("version", "?"),
             manifest.get("build_id", "?"))

    cycle = 0
    while _running:
        cycle += 1
        heartbeat = {
            "cycle":     cycle,
            "timestamp": now_iso(),
            "pid":       os.getpid(),
            "status":    "nominal",
        }
        write_atomic(RUN_PATH / "heartbeat.json", json.dumps(heartbeat, indent=2))

        if cycle % 10 == 0:
            log.info("Heartbeat #%d — status: nominal", cycle)

        time.sleep(HEARTBEAT_S)

    log.info("ARK Core Agent stopped after %d cycles", cycle)
    pid_file.unlink(missing_ok=True)

if __name__ == "__main__":
    main()
