#!/nft -f
# ARKLinux nftables ruleset — default-deny, loopback-only
# Version: 1.0.1
# Load: systemctl enable --now nftables
# Audit: nft list ruleset

flush ruleset

table inet arklinux_filter {

    # Sets for tracking state
    ct helper ftp-standard {
        type "ftp" protocol tcp
    }

    chain input {
        type filter hook input priority filter; policy drop;

        # Allow loopback unconditionally
        iif "lo" accept comment "loopback"

        # Drop invalid/malformed packets early
        ct state invalid drop comment "drop invalid"

        # Allow established and related traffic
        ct state { established, related } accept comment "established"

        # ICMP — allow ping (rate-limited)
        icmp type echo-request limit rate 5/second accept comment "ping IPv4"
        icmpv6 type { echo-request, nd-neighbor-solicit, nd-neighbor-advert,
                       nd-router-solicit, nd-router-advert, mld-listener-query } accept comment "ICMPv6 NDP"

        # SSH — operator access from loopback only (tighten to specific IP in production)
        tcp dport 22 iif "lo" accept comment "ssh loopback"

        # All other inbound: drop (logged for audit)
        log prefix "[ARK DENY INPUT] " flags all counter drop
    }

    chain forward {
        type filter hook forward priority filter; policy drop;
        log prefix "[ARK DENY FORWARD] " flags all counter drop
    }

    chain output {
        type filter hook output priority filter; policy drop;

        # Allow loopback
        oif "lo" accept comment "loopback out"

        # Allow DNS (ARK agents use local DNS only by default)
        udp dport 53 oif "lo" accept comment "DNS loopback"
        tcp dport 53 oif "lo" accept comment "DNS loopback"

        # Allow established
        ct state { established, related } accept

        # ARK services — block all external egress
        # Services are IPAddressDeny=any in their unit files; this is belt+suspenders
        ct state new meta skuid 973 drop comment "ARK egress blocked"

        # System services: allow HTTPS for package manager (pacman) only on lo
        # Tighten to specific update server IP in production
        tcp dport 443 ct state new accept comment "HTTPS out"
        tcp dport 80  ct state new accept comment "HTTP out"

        # Allow ICMP out
        icmp type echo-request accept
        icmpv6 type { echo-request, nd-neighbor-solicit, nd-neighbor-advert } accept

        log prefix "[ARK DENY OUTPUT] " flags all counter drop
    }
}

# Conntrack helper enablement (for FTP if needed in future)
table inet arklinux_nat {
    chain prerouting {
        type nat hook prerouting priority dstnat;
    }
    chain postrouting {
        type nat hook postrouting priority srcnat;
    }
}
